# Story 1.1: Project Setup and Configuration

## Status
Approved

## Story
**As a** trader,
**I want** the application to load configuration from environment variables and files,
**so that** I can securely manage API credentials and system settings.

## Acceptance Criteria

**Core Configuration Structure**
1: Project structure created with modules for trade_engine, ibkr_client, discord_notifier, and risk_manager
2: Configuration loader reads from .env file for secrets (IBKR credentials, Discord webhook)
3: System configuration (risk limits, market hours) loads from config.yaml
4: Logging framework configured with rotating file handlers outputting to logs/ directory
5: Main entry point (main.py) initializes all modules with proper error handling

**Enhanced Logging Infrastructure (Moved from Epic 4)**
6: Implement structured logging with loguru for trades, system events, and errors
7: Create separate log files: trades.log, risk.log, system.log, cli.log
8: Configure log rotation and retention policies (daily rotation, 30-day retention)
9: Establish logging standards for all modules to use consistently
10: Include request/response logging for external API calls

**User Configuration Management**
11: Create user_config.yaml for trader-specific preferences and defaults
12: Include fields: default_account_value, default_risk_category, preferred_timeframes
13: Support default execution function preferences for different trade types
14: Enable per-environment configs (separate settings for paper vs live trading)
15: Provide config validation command: `auto-trader validate-config`

**Documentation and Setup**
16: README.md documents environment setup and configuration options
17: Include configuration examples and recommended default values
18: Provide setup wizard: `auto-trader setup` for first-time configuration

## Tasks / Subtasks

- [ ] **Task 1: Create Project Structure** (AC: 1)
  - [ ] Create src/auto_trader/ main package directory
  - [ ] Create module directories: models/, trade_engine/, integrations/, risk_management/, persistence/, cli/
  - [ ] Create submodules: integrations/ibkr_client/, integrations/discord_notifier/
  - [ ] Add __init__.py files to all packages and subpackages
  - [ ] Create tests/ subdirectories in each module per architecture standards

- [ ] **Task 2: Implement Configuration System** (AC: 2, 3, 11, 14)
  - [ ] Create src/config.py with pydantic Settings class for environment variables
  - [ ] Implement config.yaml loader for system configuration
  - [ ] Create user_config.yaml support for trader preferences
  - [ ] Support environment-specific configs (.env.development, .env.production)
  - [ ] Add configuration validation with comprehensive error messages

- [ ] **Task 3: Setup Enhanced Logging Framework** (AC: 4, 6, 7, 8, 9, 10)
  - [ ] Configure loguru with structured JSON logging format
  - [ ] Create separate log handlers for trades.log, risk.log, system.log, cli.log
  - [ ] Implement daily rotation with 30-day retention policy
  - [ ] Add correlation ID support for request tracking
  - [ ] Create logging utilities for consistent module usage
  - [ ] Include request/response logging wrapper for external APIs

- [ ] **Task 4: Create Main Entry Point** (AC: 5)
  - [ ] Implement src/main.py with proper error handling
  - [ ] Initialize all modules with dependency injection
  - [ ] Add graceful shutdown handling with cleanup
  - [ ] Implement configuration loading and validation on startup

- [ ] **Task 5: CLI Commands and Validation** (AC: 15, 18)
  - [ ] Create validate-config command for configuration verification
  - [ ] Implement setup wizard for first-time configuration
  - [ ] Add help system for available commands
  - [ ] Create configuration template generation

- [ ] **Task 6: Documentation and Examples** (AC: 16, 17)
  - [ ] Update README.md with environment setup instructions
  - [ ] Create .env.example with all required environment variables
  - [ ] Create config.yaml.example with system defaults
  - [ ] Create user_config.yaml.example with trader preferences
  - [ ] Document configuration options and recommended values

- [ ] **Task 7: Testing Implementation**
  - [ ] Create unit tests for configuration loading and validation
  - [ ] Test environment variable loading with various scenarios
  - [ ] Test logging configuration and output formatting
  - [ ] Test main entry point initialization and error handling
  - [ ] Add integration tests for complete configuration workflow

## Dev Notes

### Previous Story Insights
No previous stories exist - this is the foundation story.

### Project Structure Information
[Source: architecture/source-tree.md]
- Main package: `src/auto_trader/`
- Configuration file: `src/config.py` - Settings with pydantic
- Main entry: `src/main.py` - Entry point, max 100 lines
- Module structure:
  - `models/` - Pydantic models
  - `trade_engine/` - Core execution logic  
  - `integrations/ibkr_client/` - IBKR API integration
  - `integrations/discord_notifier/` - Discord notifications
  - `risk_management/` - Risk management system
  - `persistence/` - State management
  - `cli/` - Interactive CLI components
- Test organization: `tests/` subdirectory in each module
- Configuration files: `.env.example`, `config.yaml.example`, `user_config.yaml.example`
- Log directory: `logs/` with separate files for different components

### Technology Stack Requirements
[Source: architecture/tech-stack.md]
- **Python**: 3.11.8 (exact version)
- **Package Manager**: UV 0.5.0+ (NEVER update pyproject.toml directly)
- **Configuration**: pydantic-settings 2.4.0 for environment config with .env support
- **Logging**: loguru 0.7.2 (NOT stdlib logging) - Superior to stdlib logging, rotation built-in
- **Data Validation**: pydantic 2.9.0 for settings and model validation
- **CLI Framework**: click 8.1.7 for command-line interface
- **CLI Enhancement**: rich 13.7.0 for enhanced terminal output

### Configuration and Security Requirements
[Source: architecture/security.md]
- **Secrets Management**: 
  - Development: .env file (git ignored)
  - Production: Environment variables on host system
  - Access via pydantic Settings only
  - NEVER hardcode secrets
  - No secrets in logs or error messages
- **Input Validation**: pydantic with strict mode at system boundaries
- **Environment Files**: .env.development and .env.production support
[Source: architecture/infrastructure-and-deployment.md]

### Logging Requirements
[Source: architecture/error-handling-strategy.md]
- **Library**: loguru 0.7.2
- **Format**: JSON structured logs with timestamp, level, module, message, context
- **Log Categories**: trades.log, risk.log, system.log, cli.log
- **Rotation**: Daily rotation with 30-day retention
- **Required Context**: Correlation ID (UUID), Service Context (module.function), Trade Context
- **Levels**: DEBUG (dev only), INFO (normal), WARNING (issues), ERROR (failures)

### Data Models and Validation
[Source: architecture/coding-standards.md]
- **Always use pydantic models**: Never pass raw dicts between functions
- **Type hints required**: All functions must have complete type annotations
- **No print statements**: Use logger exclusively for all output
- **UTC everywhere**: All timestamps in UTC, convert at display layer only
- **Decimal for money**: Never use float for prices or monetary values

### Component Dependencies
[Source: architecture/components.md]
- **risk_manager**: Dependencies include config.yaml for risk parameters
- **discord_notifier**: Uses httpx for webhooks, pydantic models for message formatting
- **state_manager**: Uses pydantic for serialization
- **All components**: Must use pydantic for validation, Decimal for precise calculations

### File Locations for Implementation
Based on project structure, create files at:
- `src/config.py` - Main configuration with pydantic Settings
- `src/main.py` - Application entry point
- `src/auto_trader/__init__.py` - Main package initialization
- `src/auto_trader/models/__init__.py` - Models package  
- `src/auto_trader/trade_engine/__init__.py` - Trade engine package
- `src/auto_trader/integrations/__init__.py` - Integrations package
- `src/auto_trader/integrations/ibkr_client/__init__.py` - IBKR client package
- `src/auto_trader/integrations/discord_notifier/__init__.py` - Discord notifier package
- `src/auto_trader/risk_management/__init__.py` - Risk management package
- `src/auto_trader/persistence/__init__.py` - Persistence package
- `src/auto_trader/cli/__init__.py` - CLI package
- `.env.example` - Environment template
- `config.yaml.example` - System config template
- `user_config.yaml.example` - User preferences template

### Testing

**Test Organization Standards**
[Source: architecture/test-strategy-and-standards.md]
- **Framework**: pytest 8.3.0
- **File Convention**: `test_[module_name].py`
- **Location**: `tests/` subdirectory in each module
- **Coverage Requirement**: 80% minimum
- **Test Types**: 70% unit, 20% integration, 10% end-to-end
- **Mocking**: unittest.mock + pytest fixtures
- **Patterns**: AAA pattern (Arrange, Act, Assert)
- **Fixtures**: `tests/conftest.py` for shared fixtures
- **Factories**: pydantic model factories for test objects

**Specific Testing Requirements for This Story**:
- Test configuration loading from environment variables
- Test YAML configuration file parsing and validation
- Test logging configuration and output formatting
- Test main entry point initialization and error handling
- Test CLI command functionality
- Mock external dependencies during testing
- Verify proper error messages for invalid configurations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-04 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*To be populated by QA agent*