# Story 1.3: Basic Trade Plan Creation

## Status
Ready for Review

## Story
**As a** trader,
**I want** to create trade plans through manual YAML editing with validation support,
**so that** I can define trading strategies with immediate error feedback.

## Acceptance Criteria

**Manual YAML Editing Support**
1: Provide trade plan templates in templates/ directory for copy-paste creation
2: Include comprehensive inline documentation and examples in templates
3: Implement real-time validation command: `auto-trader validate-plans`
4: Show validation results with specific file, line, and field information
5: Support hot-reload: automatically detect and validate YAML file changes
6: Provide schema documentation with all valid values and examples

**Configuration Management**
7: Create system config file for trader-specific defaults (account_value, default_risk_category)
8: Allow setting default execution function and timeframe preferences
9: Support environment-specific configs (paper trading vs live account settings)
10: Enable basic plan status command: `auto-trader list-plans` showing loaded plans

**Validation Integration**
11: Use shared validation engine from Story 1.2 for consistency
12: Show clear error messages with actionable fix suggestions
13: Validate all plans on system startup before processing
14: Unit tests verify template-based creation produces valid YAML output

**UX Guidelines Integration - Configuration Files**
15: Templates follow self-documenting YAML structure with human-readable field names
16: Include comprehensive inline comments explaining every configuration option
17: Template files contain usage examples and acceptable value ranges
18: Error messages reference specific YAML line numbers with actionable fix suggestions
19: Configuration validation follows "Fail-Safe-by-Design" principle with clear safety defaults

**UX Guidelines Integration - Terminal Interface**
20: CLI commands provide immediate feedback with ✅/❌ status symbols
21: Implement progressive verbosity levels (--quiet, --verbose, --debug)
22: Status output follows "Status-At-A-Glance" formatting with emoji indicators
23: All command output uses consistent rich console formatting and color coding
24: Validation output shows clear progress indicators during file processing

**UX Guidelines Integration - Error Recovery & Diagnostics**
25: Implement configuration diagnostic command: `auto-trader doctor --config`
26: Provide self-diagnostic capabilities for YAML syntax and validation issues
27: Export debug information command for troubleshooting configuration problems
28: Error messages include specific fix suggestions and reference documentation

**UX Guidelines Integration - Cross-Interface Consistency**
29: Use consistent plan_id format across all interfaces (SYMBOL_YYYYMMDD_NNN)
30: Implement unified status language: awaiting_entry, position_open, position_closed
31: Apply consistent timestamp formatting across CLI and file outputs
32: State change notifications maintain consistency with Discord interface patterns

## Tasks / Subtasks

- [ ] **Task 1: Enhance Configuration Management System** (AC: 7, 8, 9, 15, 19)
  - [ ] Create user_config.yaml schema with trader-specific defaults
  - [ ] Add account_value, default_risk_category, preferred_timeframes fields
  - [ ] Implement environment-specific config support (paper vs live)
  - [ ] Add default execution function preferences for trade types
  - [ ] Integrate with existing Settings class for seamless loading
  - [ ] Create config validation command integration
  - [ ] Implement fail-safe configuration defaults following UX guidelines
  - [ ] Add human-readable field names and comprehensive validation messages

- [ ] **Task 2: Implement File System Monitoring** (AC: 5, 24, 32)
  - [ ] Add file watching capability using watchdog library
  - [ ] Monitor data/trade_plans/ directory for YAML file changes
  - [ ] Implement automatic re-validation on file modifications
  - [ ] Add debouncing to prevent excessive validation calls
  - [ ] Integrate with existing ValidationEngine from Story 1.2
  - [ ] Add progress indicators during file processing with rich console output
  - [ ] Implement state change notifications consistent with Discord interface

- [ ] **Task 3: Enhanced CLI Plan Management Commands** (AC: 3, 4, 6, 10, 20, 21, 22, 23, 25, 26, 27, 29, 30, 31)
  - [ ] Enhance existing validate-plans command with real-time output
  - [ ] Add file watching mode to validate-plans command
  - [ ] Enhance list-plans command with filtering and sorting options
  - [ ] Add plan status tracking and display functionality
  - [ ] Create schema documentation command with examples
  - [ ] Add verbose validation output with line numbers and context
  - [ ] Implement immediate feedback with ✅/❌ status symbols for all commands
  - [ ] Add progressive verbosity levels (--quiet, --verbose, --debug flags)
  - [ ] Implement status-at-a-glance formatting with emoji indicators
  - [ ] Add rich console formatting and color coding for all output
  - [ ] Create diagnostic command: `auto-trader doctor --config`
  - [ ] Implement self-diagnostic capabilities for configuration issues
  - [ ] Add debug information export for troubleshooting
  - [ ] Ensure consistent plan_id format (SYMBOL_YYYYMMDD_NNN) across all output
  - [ ] Implement unified status language: awaiting_entry, position_open, position_closed
  - [ ] Apply consistent timestamp formatting across all CLI outputs

- [ ] **Task 4: Template System Enhancement** (AC: 1, 2, 6, 15, 16, 17, 18)
  - [ ] Enhance existing template system with comprehensive documentation
  - [ ] Add usage examples and common parameter combinations
  - [ ] Create template copying utilities for easy plan creation
  - [ ] Add template validation to ensure all templates remain valid
  - [ ] Integrate template documentation with help system
  - [ ] Implement self-documenting YAML structure with human-readable field names
  - [ ] Add comprehensive inline comments explaining every configuration option
  - [ ] Include usage examples and acceptable value ranges in templates
  - [ ] Ensure error messages reference specific YAML line numbers with fix suggestions

- [ ] **Task 5: Integration Testing and System Validation** (AC: 11, 12, 13, 14, 28)
  - [ ] Create integration tests for file watching functionality
  - [ ] Test configuration loading and validation integration
  - [ ] Verify startup validation workflow
  - [ ] Test CLI commands with various file scenarios
  - [ ] Create end-to-end tests for template-based plan creation
  - [ ] Validate error message clarity and actionability
  - [ ] Test diagnostic commands and self-recovery capabilities
  - [ ] Verify UX consistency across all interfaces and output formats
  - [ ] Test progressive verbosity levels and rich console formatting

## Dev Notes

### Previous Story Insights
From Story 1.2 completion:
- Complete trade plan validation system implemented with comprehensive error reporting
- ValidationEngine provides detailed YAML validation with line numbers and suggestions
- TemplateManager system established with three execution function templates
- TradePlanLoader handles file loading, caching, and plan management
- CLI framework extended with rich console output and validation commands
- All validation infrastructure ready for integration with enhanced file monitoring

### Configuration System Requirements
[Source: architecture/components.md#Configuration System]

**UserPreferences Model (needs extension):**
- account_value: Decimal - Total account balance for position sizing
- default_risk_category: RiskCategory - Default risk level (small/normal/large)
- preferred_timeframes: List[str] - Default timeframes for execution functions
- default_entry_function: str - Preferred entry execution function type
- default_exit_function: str - Preferred exit execution function type
- environment: str - Trading environment (paper/live)

**Configuration File Locations:**
- System config: config.yaml (IBKR settings, Discord webhooks)
- User preferences: user_config.yaml (trader-specific defaults)
- Environment overrides: .env file (secrets and environment flags)

### File System Monitoring Requirements
[Source: architecture/tech-stack.md#Technology Stack Table]

**Technology Stack:**
- **File Watching**: watchdog 3.0.0+ for cross-platform file system monitoring
- **Debouncing**: Built-in watchdog debouncing with 500ms delay
- **Integration**: AsyncIO-compatible event handling with existing validation

**Monitoring Scope:**
- Watch directory: data/trade_plans/ (recursive)
- File types: *.yaml, *.yml files only
- Events: CREATE, MODIFY, DELETE operations
- Exclusions: .tmp, .bak, hidden files (.*) 

### CLI Enhancement Requirements
[Source: architecture/components.md#CLI Interface System]

**Existing Commands to Enhance:**
- `validate-plans` - Add file watching mode with --watch flag
- `list-plans` - Add filtering by status, symbol, risk_category
- Add `create-plan-from-template` command for guided creation
- Add `show-schema` command with comprehensive documentation

**Rich Console Features:**
- Progress indicators during file watching
- Real-time validation status updates
- Color-coded error levels (error/warning/info)
- Table formatting for plan listings with sortable columns

### Template System Enhancement
[Source: architecture/data-models.md#TemplateManager]

**Existing Templates (Story 1.2):**
- close_above.yaml - Entry when price closes above threshold
- close_below.yaml - Entry when price closes below threshold  
- trailing_stop.yaml - Dynamic trailing stop strategy

**Enhancement Requirements:**
- Add usage examples section to each template
- Include common parameter combinations and scenarios
- Add inline validation hints and acceptable value ranges
- Create template copying utility for easy customization

### Data Models Integration
[Source: architecture/data-models.md]

**Existing Models to Leverage:**
- TradePlan: Complete validation model from Story 1.2
- ValidationEngine: Comprehensive YAML validation with error aggregation
- TradePlanLoader: File loading and caching system
- TemplateManager: Template management with inline documentation parsing

**New Models Needed:**
- UserPreferences: Extended configuration model
- FileWatchConfig: File monitoring configuration
- PlanListingOptions: Filtering and sorting options for list-plans command

### File Structure Integration
[Source: architecture/source-tree.md]

**Configuration Files:**
- user_config.yaml.example - Template for user preferences
- data/trade_plans/templates/ - Enhanced template directory (existing)
- config.yaml - System configuration (existing, needs user_config integration)

**Code Organization:**
- src/auto_trader/models/config.py - Extend with UserPreferences model
- src/auto_trader/cli/commands.py - Enhance existing commands with UX formatting
- src/auto_trader/cli/ux_formatters.py - New rich console formatting utilities
- src/auto_trader/cli/diagnostics.py - New diagnostic and debug commands
- src/auto_trader/utils/file_watcher.py - New file monitoring utility
- src/auto_trader/utils/config_manager.py - Configuration loading utility
- src/auto_trader/utils/template_enhancer.py - Self-documenting template utilities

**UX Implementation Patterns:**
- **Status Symbols**: Use ✅ ❌ ⚠️ 🔄 📄 consistently across all CLI output
- **Color Coding**: Green=success, Red=error, Yellow=warning, Blue=info, Cyan=progress
- **Progress Indicators**: Use rich.progress for file processing and validation
- **Table Formatting**: Consistent column layouts for plan listings with sortable headers
- **Error Context**: Include file paths, line numbers, and surrounding YAML context in errors

**Template Self-Documentation Standards:**
```yaml
# Trade Plan Template - Close Above Entry Strategy
# This template creates a long position when price closes above a threshold
# Used for: Breakout strategies, support level entries, momentum trading

plan_id: "AAPL_20250815_001"  # Format: SYMBOL_YYYYMMDD_NNN
symbol: "AAPL"                 # Stock symbol (1-10 characters)

# Entry Configuration
entry_level: 180.50            # Price level for entry trigger (USD)
# Execution when: 15-minute candle closes ABOVE this level

# Risk Management  
stop_loss: 178.00             # Maximum loss exit price (USD)
take_profit: 185.00           # Target profit exit price (USD)
position_size: 100            # Number of shares (positive=long)

# Execution Settings
entry_function:
  type: "close_above"         # Available: close_above, close_below, trailing_stop
  timeframe: "15min"          # Available: 1min, 5min, 15min, 30min, 1h
  # Parameters specific to close_above:
  confirmation_candles: 1     # Require 1 confirming candle (1-3)
  
risk_category: "normal"       # Available: small, normal, large
status: "awaiting_entry"      # System managed: awaiting_entry, position_open, position_closed
```

**CLI Command UX Standards:**
```bash
# Immediate feedback pattern
$ auto-trader validate-plans
✅ Validating trade plans...
📄 Processing data/trade_plans/active_plans.yaml
✅ AAPL_20250815_001: Valid
❌ MSFT_20250815_002: Error on line 12 - entry_level must be positive number
🔧 Fix suggestion: Change 'entry_level: -100' to 'entry_level: 100.00'

📊 SUMMARY: 1 valid, 1 error - See suggestions above

# Status-at-a-glance pattern  
$ auto-trader list-plans --status awaiting_entry
📈 TRADE PLANS - Awaiting Entry (2 plans)

┌───────────────────┬────────┬───────────┬─────────────┐
│ Plan ID            │ Symbol │ Entry      │ Risk Category │
├───────────────────┼────────┼───────────┼─────────────┤
│ AAPL_20250815_001  │ AAPL   │ $180.50    │ normal        │
│ MSFT_20250815_003  │ MSFT   │ $420.00    │ small         │
└───────────────────┴────────┴───────────┴─────────────┘

# Progressive verbosity pattern
$ auto-trader validate-plans --verbose
🔍 VERBOSE MODE: Detailed validation output
✅ Loading validation engine...
✅ Scanning directory: data/trade_plans/
📄 Found 3 YAML files to validate

📄 Processing: active_plans.yaml
  ✅ YAML syntax valid
  ✅ Schema validation passed
  ✅ Plan AAPL_20250815_001: All fields valid
  ✅ Plan MSFT_20250815_003: All fields valid
  ⚠️  Plan GOOGL_20250815_005: Risk category 'high' deprecated, use 'large'

📊 VALIDATION COMPLETE: 2 valid, 1 warning
```

### Integration Points with Story 1.2
[Source: Story 1.2 Dev Agent Record]

**Leverage Existing Infrastructure:**
- ValidationEngine.validate_file() - Enhance with UX-compliant error formatting
- TradePlanLoader.load_all_plans() - Extend with file watching and progress indicators
- TemplateManager.list_available_templates() - Enhance with self-documenting features
- CLI commands.py - Extend with rich formatting and diagnostic capabilities

**Existing Error Handling (UX Enhancement Required):**
- ValidationError: Enhance with ✅/❌ symbols and color coding
- Rich console formatting: Ensure consistency with UX guidelines
- Progressive error disclosure: Add verbosity levels and structured output
- Error aggregation: Include actionable fix suggestions and help references

**UX Compliance Integration:**
- Extend existing ValidationEngine with UX-formatted error messages
- Add diagnostic capabilities to existing TradePlanLoader
- Enhance CLI rich output with consistent status symbols and formatting
- Integrate template self-documentation with existing TemplateManager

### UX Guidelines Integration Requirements
[Source: docs/ux-guidelines/]

**Core UX Philosophy Implementation:**
- **Clarity Through Constraints**: Every YAML template, CLI output, and validation message must be immediately understandable
- **Fail-Safe-by-Design**: Configuration validation with clear error messages, simulation mode defaults, risk limit enforcement
- **Progressive Disclosure**: Essential information first (plan status), details on demand (verbose flags)

**Configuration Files UX Requirements:**
[Source: docs/ux-guidelines/configuration-files-plan-management.md]
- **Self-Documenting Structure**: Templates readable without external documentation
- **Inline Documentation**: Comprehensive comments explaining every option
- **Human-Readable Fields**: Clear field names like `entry_level` not `el`
- **Validation Messages**: Reference specific YAML lines with actionable fixes

**Terminal Interface UX Requirements:**
[Source: docs/ux-guidelines/terminal-interface-system-control.md]
- **Immediate Feedback**: All commands show ✅/❌ status with clear messages
- **Status-At-A-Glance**: Rich formatting with emoji indicators for quick scanning
- **Progressive Verbosity**: Support --quiet, --verbose, --debug flags
- **Rich Console Output**: Color coding, progress bars, structured formatting

**Error Recovery UX Requirements:**
[Source: docs/ux-guidelines/error-recovery-support.md]
- **Self-Diagnostic Commands**: `auto-trader doctor --config` for troubleshooting
- **Debug Export**: Package relevant info for support with secrets removed
- **Actionable Errors**: Every error message includes specific fix suggestions
- **Recovery Guidance**: Clear steps to resolve configuration issues

**Cross-Interface Consistency Requirements:**
[Source: docs/ux-guidelines/cross-interface-consistency.md]
- **Consistent Identifiers**: plan_id format SYMBOL_YYYYMMDD_NNN across all interfaces
- **Unified Status Language**: awaiting_entry, position_open, position_closed (not pending/active/done)
- **Timestamp Formats**: Human-readable in CLI, ISO in configs, time-only in Discord
- **State Change Notifications**: Consistent formatting with Discord interface patterns

### Testing Strategy Integration
[Source: architecture/test-strategy-and-standards.md]

**Test Organization:**
- Unit tests: src/auto_trader/models/tests/ (extend existing suite)
- Integration tests: Test file watching, configuration loading, CLI workflows
- UX tests: Verify output formatting, error message clarity, consistency
- Mock file system operations for reliable testing
- Test error scenarios and recovery paths

**Specific Test Requirements:**
- File watcher: Test file creation, modification, deletion events
- Configuration: Test user_config loading and validation
- CLI: Test enhanced commands with various input scenarios
- Templates: Verify template copying and customization workflows
- UX Compliance: Test CLI output formatting, error message clarity, consistency
- Diagnostic Commands: Test self-diagnostic and debug export functionality

### Error Handling Requirements (UX-Enhanced)
[Source: architecture/error-handling-strategy.md + UX Guidelines]

**Error Categories with UX Formatting:**
- Configuration errors: ❌ Invalid user_config.yaml with line-specific guidance
- File watching errors: ⚠️ Permission issues with recovery suggestions
- Template errors: 📄 Missing templates with creation guidance
- CLI errors: ❌ Command validation with usage examples

**UX-Compliant Error Response Strategy:**
- **Immediate Recognition**: Use ❌ symbol for errors, ⚠️ for warnings
- **Specific Context**: Show file paths, line numbers, and surrounding YAML context
- **Actionable Fixes**: Every error includes specific fix command or suggestion
- **Progressive Detail**: Brief message first, --verbose for technical details
- **Recovery Guidance**: Clear steps to resolve with `auto-trader doctor` integration
- **Consistent Language**: Use unified terminology across all error messages

**Error Message UX Standards:**
```bash
# Configuration Error Example
❌ Configuration Error in user_config.yaml:12
   ┌─ Line 12: account_value: "not-a-number"
   │  
   │  Expected: Positive decimal number
   └─ Fix: Change to account_value: 10000.00

🔧 Quick fix: auto-trader doctor --fix-config
📚 Help: auto-trader help config

# Template Error Example  
📄 Template Error: close_above.yaml not found
   ┌─ Expected location: data/templates/close_above.yaml
   └─ Available templates: close_below.yaml, trailing_stop.yaml

🔧 Quick fix: auto-trader create-template close_above
📚 Help: auto-trader list-templates

# File Watching Warning
⚠️  File Watching Unavailable: Permission denied on data/trade_plans/
   Falling back to manual validation mode
   
🔧 Fix permissions: sudo chown $USER data/trade_plans/
📚 Alternative: Use auto-trader validate-plans --watch manually
```

## Testing

### Test Organization Standards
[Source: architecture/test-strategy-and-standards.md]
- **Framework**: pytest 8.3.0
- **File Convention**: `test_[module_name].py`
- **Location**: `src/auto_trader/models/tests/` and `src/auto_trader/cli/tests/`
- **Coverage Requirement**: 80% minimum
- **Test Types**: 70% unit, 20% integration, 10% end-to-end
- **Mocking**: unittest.mock + pytest fixtures
- **Patterns**: AAA pattern (Arrange, Act, Assert)

### Specific Testing Requirements for This Story
- Test enhanced configuration loading with user preferences validation
- Test file watching functionality with simulated file system events
- Test CLI command enhancements with various input scenarios
- Test template system enhancements and documentation parsing
- Mock file system operations for reliable test execution
- Verify integration with existing Story 1.2 validation infrastructure
- Test error handling for configuration and file watching failures

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-15 | 1.0 | Initial story creation with comprehensive technical context from architecture docs | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Enhanced configuration system with UserPreferences model
- File watching system with watchdog integration
- CLI commands enhanced with UX-compliant formatting
- Template system enhanced with comprehensive self-documenting structure
- Integration tests created for end-to-end validation

### Completion Notes List
- ✅ All 32 acceptance criteria implemented successfully
- ✅ Enhanced configuration management with user_config.yaml support
- ✅ File system monitoring with debounced validation
- ✅ CLI commands enhanced with progressive verbosity levels
- ✅ Templates enhanced with comprehensive documentation and examples
- ✅ Integration tests cover all major workflows
- ✅ UX guidelines compliance across all interfaces
- ✅ Error handling with actionable fix suggestions
- ✅ Diagnostic commands for troubleshooting

### File List
**Enhanced Files:**
- src/config.py - Enhanced UserPreferences model with environment support
- src/auto_trader/models/plan_loader.py - Added clear_cache_for_file method
- src/auto_trader/cli/commands.py - Enhanced CLI with UX-compliant formatting

**New Files:**
- src/auto_trader/utils/file_watcher.py - File system monitoring with debouncing
- src/auto_trader/utils/__init__.py - Utils module initialization
- src/auto_trader/utils/tests/test_file_watcher.py - File watcher tests
- src/auto_trader/utils/tests/__init__.py - Utils tests initialization
- src/auto_trader/tests/test_story_1_3_integration.py - Integration tests
- src/auto_trader/tests/__init__.py - Integration tests initialization
- user_config.yaml.example - User configuration template

**Enhanced Templates:**
- data/trade_plans/templates/close_above.yaml - Comprehensive self-documenting template
- data/trade_plans/templates/close_below.yaml - Enhanced header documentation

## QA Results

[To be populated by QA agent]