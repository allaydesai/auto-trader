# Story 1.5.2: Interactive CLI Creation Wizard

## Status
Draft

## Story
**As a** trader,
**I want** an interactive CLI wizard to create trade plans with real-time validation,
**so that** I can efficiently create error-free plans with immediate feedback.

## Acceptance Criteria

**Core CLI Wizard Flow**
1: Implement command: `auto-trader create-plan` to launch interactive wizard
2: Prompt for each required field with current value display and validation
3: Show acceptable values for each field (e.g., "risk_category [small/normal/large]:")
4: Validate each input immediately and request correction if invalid
5: Calculate and display estimated position size during creation process using Epic 1.5.1 risk management
6: Allow plan preview before final save to YAML file

**Risk Integration**
7: Integrate with automated position sizing from Story 1.5.1 for real-time calculations
8: Display current portfolio risk and impact of new plan during creation
9: Block plan creation if it would exceed 10% portfolio risk limit
10: Show clear risk breakdown: individual trade risk + current portfolio risk
11: Provide risk-based suggestions for position size adjustments

**Enhanced User Experience**
12: Support CLI shortcuts: `auto-trader create-plan --symbol AAPL --entry 180.50`
13: Pre-populate fields from user configuration defaults
14: Allow modification of entered values before final confirmation
15: Provide clear error recovery for invalid inputs
16: Save completed plans to appropriate YAML files with proper formatting

**Validation Integration**
17: Use shared validation engine from Epic 1 Story 1.2 for consistency
18: Show validation results with specific error details
19: Unit tests verify wizard-created plans match manual YAML creation
20: Log all wizard interactions to cli.log for debugging

## Tasks / Subtasks

- [ ] **Task 1: Enhance CLI Framework for Interactive Wizard** (AC: 1, 12, 20)
  - [ ] Create `create_plan_interactive()` command using Click framework integration
  - [ ] Implement CLI shortcut parameter support (--symbol, --entry, --stop, --target, --risk)
  - [ ] Add wizard interaction logging to cli.log with structured format
  - [ ] Integrate with existing modular CLI architecture in plan_commands.py
  - [ ] Use Rich console framework for enhanced terminal experience with colors and formatting

- [ ] **Task 2: Implement Interactive Field Collection with Real-time Validation** (AC: 2, 3, 4, 13, 15, 17, 18)
  - [ ] Create field prompting system with acceptable value hints and current value display
  - [ ] Implement immediate input validation using ValidationEngine from Story 1.2
  - [ ] Add clear error recovery flow for invalid inputs with specific error details
  - [ ] Pre-populate fields from user configuration defaults using Settings model
  - [ ] Support field modification before final confirmation using Rich prompts
  - [ ] Integrate with existing validation patterns from validation_engine.py

- [ ] **Task 3: Integrate Real-time Risk Management and Position Sizing** (AC: 5, 7, 8, 9, 10, 11)
  - [ ] Integrate with RiskManager from Story 1.5.1 for live position size calculations
  - [ ] Display current portfolio risk status at wizard start using portfolio tracking
  - [ ] Show real-time risk impact as user enters entry/stop/risk values
  - [ ] Implement portfolio risk limit validation (10% maximum) with clear blocking
  - [ ] Provide risk-based position size adjustment suggestions
  - [ ] Calculate and display individual trade risk + total portfolio risk breakdown

- [ ] **Task 4: Plan Preview and Confirmation System** (AC: 6, 14, 16)
  - [ ] Create plan preview display with Rich formatting showing all entered values
  - [ ] Allow field modification during preview stage before final save
  - [ ] Implement YAML file save with proper formatting to data/trade_plans/ directory
  - [ ] Generate unique plan_id following SYMBOL_YYYYMMDD_NNN format
  - [ ] Validate final plan against TradePlan model before saving

- [ ] **Task 5: Testing and Integration Validation** (AC: 19, 20)
  - [ ] Create comprehensive unit tests for wizard flow and field validation
  - [ ] Add integration tests verifying wizard-created plans match manual YAML creation
  - [ ] Test CLI shortcut parameter combinations and edge cases
  - [ ] Validate logging integration and structured output to cli.log
  - [ ] Test risk management integration accuracy and error handling
  - [ ] Verify UX compliance with fail-safe defaults and progressive disclosure

## Dev Notes

### Previous Story Insights
From Story 1.5.1 completion:
- Complete risk management system implemented with RiskManager, PositionSizer, and PortfolioTracker classes
- CLI integration established with rich formatting and risk display capabilities
- Position size calculation available via `calculate_position_size()` method
- Portfolio risk tracking with 10% limit enforcement in place
- Real-time risk calculations ready for wizard integration

### CLI Framework Integration
[Source: architecture/tech-stack.md#Technology Stack Table + architecture/source-tree.md#CLI Interface]

**Existing CLI Infrastructure:**
- Click 8.1.7 framework for command-line interface with decorator-based commands
- Rich 13.7.0 for enhanced terminal output with colors, tables, and interactive prompts
- Modular CLI architecture in `src/auto_trader/cli/` with plan_commands.py (266 lines)
- Established patterns for error handling, logging, and user interaction

**Integration Points:**
- Extend plan_commands.py with new `create_plan_interactive()` command
- Use existing display_utils.py for Rich console formatting patterns
- Leverage error_utils.py for consistent error handling
- Integrate with existing logging_config.py for cli.log output

### Data Models and Validation Integration
[Source: architecture/data-models.md + architecture/components.md#ValidationEngine]

**TradePlan Model Requirements:**
- plan_id: str (format: SYMBOL_YYYYMMDD_NNN)
- symbol: str (1-10 uppercase chars, no special characters)
- entry_level: Decimal (positive, max 4 decimal places)
- stop_loss: Decimal (positive, max 4 decimal places, ≠ entry_level)
- take_profit: Decimal (positive, max 4 decimal places)
- risk_category: RiskCategory enum (small=1%, normal=2%, large=3%)
- entry_function: ExecutionFunction (close_above, close_below, trailing_stop)
- exit_function: ExecutionFunction

**Validation Engine Integration:**
- Use `validate_plan_data()` method for real-time field validation
- Leverage existing validation rules and error message formatting
- Integrate with ValidationResult and ValidationError models
- Follow established validation patterns from Story 1.2

### Risk Management Integration
[Source: architecture/components.md#risk_manager + Story 1.5.1 implementation]

**RiskManager Integration (Story 1.5.1):**
```python
# Available methods from Story 1.5.1 implementation
risk_manager.calculate_position_size(account_balance, risk_percent, entry_price, stop_price) -> PositionSizeResult
risk_manager.check_portfolio_risk_limit(new_trade_risk) -> RiskCheck
risk_manager.get_current_portfolio_risk() -> Decimal
risk_manager.validate_trade_plan(trade_plan, account_balance) -> RiskValidationResult
```

**Portfolio Risk Display:**
- Show current portfolio risk percentage before wizard starts
- Real-time calculation during entry/stop/risk input
- Clear risk breakdown: individual trade risk + current portfolio risk
- 10% portfolio limit enforcement with blocking and suggestions

### CLI Wizard Workflow Implementation
[Source: architecture/core-workflows.md#CLI Trade Plan Creation Workflow]

**Sequential Wizard Flow:**
1. Display current portfolio status and risk capacity
2. Prompt for symbol with validation (1-10 uppercase chars)
3. Prompt for entry level with price validation (positive decimal)
4. Prompt for stop loss with validation (≠ entry, positive decimal)
5. Calculate and display stop distance percentage
6. Prompt for risk category with enum validation (small/normal/large)
7. Calculate and display position size + dollar risk in real-time
8. Check portfolio risk limit and show new total
9. Prompt for take profit with validation
10. Select execution function and timeframe
11. Show complete plan preview with Rich formatting
12. Confirm save and write to YAML file

### UX Guidelines Implementation
[Source: docs/ux-guidelines/core-ux-philosophy.md + safety-risk-management-ux.md]

**Fail-Safe by Design:**
- Validate all inputs immediately with clear error messages
- Default to simulation mode safety settings
- Block dangerous trades that exceed portfolio risk limits
- Provide clear recovery paths for validation errors

**Progressive Disclosure:**
- Start with essential portfolio context
- Show field hints and acceptable values
- Display calculated values as user progresses
- Reveal full plan preview before final confirmation

**Clarity Through Constraints:**
- Each prompt shows exactly what is expected
- Validation errors provide specific correction guidance
- Risk calculations displayed in clear, understandable format
- Status indicators use consistent iconography (✅❌⚠️)

### File Structure and Integration Points
[Source: architecture/source-tree.md]

**Files to Modify/Create:**
- `src/auto_trader/cli/plan_commands.py` - Add create_plan_interactive command
- `src/auto_trader/cli/wizard_utils.py` - New file for wizard-specific utility functions
- `src/auto_trader/cli/tests/test_plan_commands.py` - Enhance with wizard tests
- `src/auto_trader/cli/tests/test_wizard_utils.py` - New test file for wizard utilities

**Integration Dependencies:**
- `auto_trader.models.TradePlan` - Core data model validation
- `auto_trader.models.ValidationEngine` - Real-time input validation
- `auto_trader.risk_management.RiskManager` - Position sizing and risk calculations
- `auto_trader.cli.display_utils` - Rich console formatting patterns
- `auto_trader.logging_config` - Structured logging to cli.log

## Testing

### Test File Locations
[Source: architecture/test-strategy-and-standards.md]
- **Framework**: pytest 8.3.0
- **Location**: `src/auto_trader/cli/tests/`
- **Files**: `test_plan_commands.py` (enhance existing), `test_wizard_utils.py` (new)
- **Coverage**: 80% minimum for CLI components

### Testing Requirements
- **Test Types**: 70% unit tests, 20% integration tests, 10% end-to-end
- **Mocking**: unittest.mock + pytest fixtures for external dependencies
- **CLI Testing**: Click testing framework for command execution
- **Risk Integration**: Mock RiskManager for predictable test scenarios

### Specific Testing Scenarios
- Interactive wizard flow with all field types and validation
- CLI shortcut parameter combinations and edge cases
- Risk management integration accuracy and portfolio limit enforcement
- Validation error handling and recovery flows
- YAML file creation and format verification
- Logging integration and structured output validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial story creation with comprehensive technical context from architecture docs and Story 1.5.1 risk management integration | Scrum Master |