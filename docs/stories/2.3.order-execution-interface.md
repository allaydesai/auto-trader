# Story 2.3: Order Execution Interface

## Status
Draft

## Story
**As a** trader,
**I want** to place and manage orders through IBKR,
**so that** my trades execute in the market.

## Acceptance Criteria

1: Calculate position size using risk management module before placing orders
2: Place market orders for trade plan entries with calculated position size
3: Place stop-loss orders immediately after entry fill confirmation
4: Place take-profit orders immediately after entry fill confirmation
5: Modify existing orders (for trailing stops) without creating duplicates
6: Order status tracked and logged (submitted, filled, cancelled, rejected)
7: Failed orders trigger Discord notification with error details
8: Risk limit violations prevent order placement and trigger error notifications

## Tasks / Subtasks

- [ ] **Task 1: Implement Core Order Models and Types** (AC: 1, 2, 6)
  - [ ] Create Order pydantic model with validation for order data
  - [ ] Implement OrderType enum (MARKET, LIMIT, STOP) and OrderSide enum (BUY, SELL)
  - [ ] Add OrderStatus enum for tracking order lifecycle (SUBMITTED, FILLED, CANCELLED, REJECTED, PENDING)
  - [ ] Create OrderRequest model for order placement requests with position size calculation
  - [ ] Add comprehensive validation for order parameters and risk checks
  - [ ] Create OrderResult model for order execution responses with status tracking

- [ ] **Task 2: Build Order Execution Manager** (AC: 2, 3, 4, 5, 6)
  - [ ] Extend IBKRClient with order execution capabilities using ib-async
  - [ ] Implement market order placement with position size integration
  - [ ] Add bracket order support for simultaneous stop-loss and take-profit placement
  - [ ] Create order modification system for trailing stops without duplication
  - [ ] Implement order status tracking with event-driven updates
  - [ ] Add order cancellation and error handling mechanisms

- [ ] **Task 3: Risk Management Integration** (AC: 1, 8)
  - [ ] Integrate risk management module for pre-order position size calculation
  - [ ] Implement risk limit validation before order placement
  - [ ] Add portfolio risk checks to prevent exceeding 10% total risk limit
  - [ ] Create risk violation error handling with clear error messages
  - [ ] Add position size validation against account balance and available capital
  - [ ] Implement risk-based order rejection with detailed logging

- [ ] **Task 4: Order Status Management and Tracking** (AC: 6, 7)
  - [ ] Create order tracking system with status updates and lifecycle management
  - [ ] Implement order event handling for fill confirmations and status changes
  - [ ] Add order persistence for recovery across system restarts
  - [ ] Create comprehensive order logging with structured data
  - [ ] Implement error notification system for failed orders via Discord
  - [ ] Add order reconciliation with IBKR to ensure state consistency

- [ ] **Task 5: Integration Testing and Error Handling** (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create comprehensive unit tests for order models and execution manager
  - [ ] Test order placement with IBKR paper trading account integration
  - [ ] Add integration tests for bracket order placement and status tracking
  - [ ] Test risk management integration and order rejection scenarios
  - [ ] Validate order modification and cancellation functionality
  - [ ] Create tests for error handling and Discord notification integration

## Dev Notes

### Previous Story Insights
From Story 2.2 completion:
- Market data subscription system established with BarData, MarketData, and MarketDataCache models
- IBKRClient extended with market data capabilities and subscription management
- Market data distribution system available for execution engine integration
- Real-time bar updates with quality validation and stale data detection
- Comprehensive testing patterns established with 51+ tests and 95% coverage
- ib-async 2.0.1 integration patterns proven with connection management and event handling

### Technology Stack Integration
[Source: docs/architecture/tech-stack.md#Technology Stack Table]

**Order Execution Integration Requirements:**
- **Primary Library:** ib-async 2.0.1+ for order placement, modification, and status tracking
- **Data Validation:** pydantic 2.9.0 for order model validation and type safety
- **Data Processing:** Decimal for precise monetary calculations and position sizing
- **Async Runtime:** asyncio (stdlib) for concurrent order processing and event handling
- **Logging:** loguru 0.7.2 for structured order event logging and execution tracking
- **HTTP Client:** httpx 0.27.0 for Discord webhook notifications on order failures

**Critical Version Requirements:**
- Python 3.11.8 exactly (IBKR API compatibility requirement)
- ib-async 2.0.1+ for modern order execution patterns and event handling
- pydantic 2.9.0 for order validation and model consistency

### Order Models and Validation
[Source: docs/architecture/data-models.md#Future Models + docs/architecture/coding-standards.md#Critical Rules]

**Core Order Model Design:**
```python
class Order(BaseModel):
    """Represents a trading order with validation."""
    order_id: Optional[str] = Field(None, description="IBKR order ID")
    symbol: str = Field(..., min_length=1, max_length=10)
    side: OrderSide = Field(..., description="BUY or SELL")
    order_type: OrderType = Field(..., description="MARKET, LIMIT, STOP")
    quantity: int = Field(..., gt=0)
    price: Optional[Decimal] = Field(None, gt=0, decimal_places=4)
    stop_price: Optional[Decimal] = Field(None, gt=0, decimal_places=4)
    status: OrderStatus = Field(default=OrderStatus.PENDING)
    created_at: datetime = Field(default_factory=lambda: datetime.now(UTC))
    filled_at: Optional[datetime] = Field(None)
    filled_price: Optional[Decimal] = Field(None, decimal_places=4)
    filled_quantity: int = Field(default=0, ge=0)
    
    model_config = ConfigDict(
        validate_assignment=True,
        str_strip_whitespace=True,
        use_enum_values=True
    )

class OrderRequest(BaseModel):
    """Request model for order placement with risk calculation."""
    trade_plan_id: str = Field(..., description="Associated trade plan")
    symbol: str = Field(..., min_length=1, max_length=10)
    side: OrderSide = Field(..., description="BUY or SELL")
    entry_price: Decimal = Field(..., gt=0, decimal_places=4)
    stop_loss: Decimal = Field(..., gt=0, decimal_places=4)
    take_profit: Decimal = Field(..., gt=0, decimal_places=4)
    risk_category: RiskCategory = Field(..., description="Risk level for position sizing")
    calculated_position_size: Optional[int] = Field(None, gt=0)
    
class OrderResult(BaseModel):
    """Result of order execution with status and error information."""
    success: bool = Field(..., description="Order placement success")
    order_id: Optional[str] = Field(None, description="IBKR order ID if successful")
    error_message: Optional[str] = Field(None, description="Error details if failed")
    order_status: OrderStatus = Field(..., description="Current order status")
    timestamp: datetime = Field(default_factory=lambda: datetime.now(UTC))
```

### IBKR Order Execution Integration
[Source: docs/architecture/components.md#ibkr_client + Story 2.2 completion notes]

**Order Execution Manager Extension:**
```python
class IBKRClient:
    # Existing connection and market data management from Stories 2.1 and 2.2...
    
    async def place_market_order(self, order_request: OrderRequest) -> OrderResult:
        """Place market order with position size calculation and risk validation."""
        
    async def place_bracket_order(self, entry_order: Order, stop_loss_price: Decimal, take_profit_price: Decimal) -> OrderResult:
        """Place bracket order with simultaneous stop-loss and take-profit orders."""
        
    async def modify_order(self, order_id: str, new_price: Optional[Decimal] = None, new_quantity: Optional[int] = None) -> OrderResult:
        """Modify existing order without creating duplicates."""
        
    async def cancel_order(self, order_id: str) -> OrderResult:
        """Cancel pending order."""
        
    def _on_order_status_update(self, order_status) -> None:
        """Handle real-time order status updates from ib-async."""
        
    async def get_order_status(self, order_id: str) -> OrderStatus:
        """Get current order status from IBKR."""
        
    async def get_open_orders(self) -> List[Order]:
        """Get all open orders for the account."""
```

**Order Status Tracking:**
```python
# Order status enum mapping to IBKR status
ORDER_STATUS_MAPPING = {
    "PendingSubmit": OrderStatus.PENDING,
    "Submitted": OrderStatus.SUBMITTED,
    "Filled": OrderStatus.FILLED,
    "Cancelled": OrderStatus.CANCELLED,
    "Rejected": OrderStatus.REJECTED,
    "PreSubmitted": OrderStatus.SUBMITTED
}
```

### File Structure and Implementation Locations
[Source: docs/architecture/source-tree.md#Future Models]

**Files to Create/Modify:**
- `src/auto_trader/models/order.py` - Order, OrderRequest, and OrderResult models (~200 lines)
- `src/auto_trader/models/enums.py` - OrderType, OrderSide, OrderStatus enums (~100 lines)
- `src/auto_trader/integrations/ibkr_client/order_manager.py` - Order execution logic (~300 lines)
- `src/auto_trader/integrations/ibkr_client/order_tracker.py` - Order status tracking (~200 lines)
- `src/auto_trader/models/tests/test_order.py` - Order model tests
- `src/auto_trader/integrations/ibkr_client/tests/test_order_manager.py` - Order execution tests
- `src/auto_trader/integrations/ibkr_client/tests/test_order_tracker.py` - Order tracking tests

**Integration Points:**
- Extend existing `IBKRClient` from Stories 2.1 and 2.2 with order execution capabilities
- Integrate with existing risk management system from Epic 1 for position sizing
- Use established connection management and circuit breaker systems
- Leverage market data system for price validation and execution timing

### Risk Management Integration
[Source: docs/architecture/components.md#risk_manager + docs/architecture/coding-standards.md#Critical Rules]

**Position Size Calculation:**
- **Small Risk:** 1% account risk per trade
- **Normal Risk:** 2% account risk per trade
- **Large Risk:** 3% account risk per trade
- **Portfolio Limit:** Maximum 10% total portfolio risk across all open positions
- **Position Size Formula:** `Position Size = (Account Value Ã— Risk %) Ã· |Entry Price - Stop Loss Price|`

**Risk Validation Requirements:**
```python
class OrderExecutionManager:
    async def validate_order_risk(self, order_request: OrderRequest) -> RiskValidationResult:
        """Validate order against risk limits before placement."""
        # Calculate position size using risk management module
        position_size = await self.risk_manager.calculate_position_size(
            account_balance=self.account_balance,
            risk_percent=order_request.risk_category.value,
            entry_price=order_request.entry_price,
            stop_price=order_request.stop_loss
        )
        
        # Check portfolio risk limit (10% maximum)
        portfolio_risk_check = await self.risk_manager.check_portfolio_risk_limit(
            new_trade_risk=position_size.dollar_risk
        )
        
        if not portfolio_risk_check.passed:
            raise RiskLimitExceeded(
                limit_type="portfolio_risk",
                current=portfolio_risk_check.current_risk,
                max_allowed=portfolio_risk_check.max_allowed
            )
```

### Order Status Management and Error Handling
[Source: docs/architecture/error-handling-strategy.md + docs/architecture/coding-standards.md]

**Order Error Handling Strategy:**
```python
class OrderExecutionError(Exception):
    """Base exception for order execution errors."""
    pass

class RiskLimitExceeded(OrderExecutionError):
    """Order rejected due to risk limit violations."""
    pass

class OrderRejectedError(OrderExecutionError):
    """Order rejected by IBKR."""
    pass

class OrderStatusError(OrderExecutionError):
    """Order status tracking error."""
    pass
```

**Order Event Logging:**
```python
# Order execution event logging
logger.info("Order placement initiated",
           trade_plan_id=order_request.trade_plan_id,
           symbol=order_request.symbol,
           side=order_request.side,
           quantity=calculated_position_size)

logger.info("Order filled successfully",
           order_id=order_id,
           symbol=symbol,
           filled_price=filled_price,
           filled_quantity=filled_quantity,
           execution_time=filled_at)

logger.error("Order placement failed",
            trade_plan_id=order_request.trade_plan_id,
            symbol=order_request.symbol,
            error=str(e),
            risk_check_passed=risk_validation.passed)
```

### Discord Notification Integration
[Source: docs/architecture/components.md#discord_notifier]

**Order Event Notifications:**
```python
class DiscordNotifier:
    async def send_order_placement_notification(self, order: Order) -> None:
        """Send order placement notification."""
        message = f"""
ðŸŸ¡ **ORDER PLACED**
**Symbol:** {order.symbol}
**Side:** {order.side}
**Type:** {order.order_type}
**Quantity:** {order.quantity}
**Price:** ${order.price:.2f} (if applicable)
**Status:** {order.status}
**Time:** {order.created_at.strftime('%H:%M:%S')}
        """.strip()
        
    async def send_order_fill_notification(self, order: Order) -> None:
        """Send order fill notification."""
        fill_emoji = "ðŸŸ¢" if order.side == "BUY" else "ðŸ”´"
        message = f"{fill_emoji} **ORDER FILLED** | {order.symbol} {order.side} {order.filled_quantity} @ ${order.filled_price:.2f}"
        
    async def send_order_error_notification(self, error: OrderExecutionError, order_request: OrderRequest) -> None:
        """Send order error notification."""
        message = f"""
âŒ **ORDER FAILED**
**Symbol:** {order_request.symbol}
**Error:** {error}
**Plan ID:** {order_request.trade_plan_id}
**Time:** {datetime.now(UTC).strftime('%H:%M:%S')}
        """.strip()
```

### Order Persistence and State Recovery
[Source: docs/architecture/components.md#state_manager]

**Order State Management:**
```python
class OrderTracker:
    def __init__(self):
        self._active_orders: Dict[str, Order] = {}
        self._order_history: List[Order] = []
        
    async def save_order_state(self) -> None:
        """Persist order state to JSON file."""
        order_state = {
            "active_orders": [order.model_dump() for order in self._active_orders.values()],
            "last_updated": datetime.now(UTC).isoformat()
        }
        
    async def load_order_state(self) -> None:
        """Load order state from JSON file on startup."""
        
    async def reconcile_with_ibkr(self) -> None:
        """Reconcile local order state with IBKR."""
```

### Performance and Memory Management
[Source: docs/architecture/coding-standards.md + CLAUDE.md Performance]

**Performance Requirements:**
- **Order Placement Latency:** <1 second from signal to order submission
- **Status Update Processing:** <100ms for order status updates
- **Memory Management:** Maximum 10,000 order records in memory with automatic archiving
- **Error Recovery:** Automatic retry for transient errors with exponential backoff

### Testing
[Source: docs/architecture/test-strategy-and-standards.md]

**Testing Framework:** pytest 8.3.0 with pytest-asyncio 0.24.0 for async order execution components
**Test Location:** `src/auto_trader/models/tests/` and `src/auto_trader/integrations/ibkr_client/tests/`
**Coverage Requirement:** 80% minimum for order execution components, 100% for risk validation

**Testing Standards and Requirements:**

**Unit Test Files:**
- `test_order.py` - Order, OrderRequest, and OrderResult model validation
- `test_order_manager.py` - Order execution manager functionality and error handling
- `test_order_tracker.py` - Order status tracking and persistence
- `test_risk_integration.py` - Risk management integration and validation

**Integration Test Requirements:**
- **IBKR Order Execution:** Use IBKR paper trading account for real order placement testing
- **Risk Management Integration:** Test position size calculation and portfolio risk checks
- **Order Status Tracking:** Test real-time order status updates and state persistence
- **Error Handling:** Test order rejection scenarios and error notification system
- **Discord Integration:** Test order event notifications and error alerts

**Testing Scenarios:**
- Order model validation with various order configurations and risk categories
- Market order placement with position size calculation and risk validation
- Bracket order placement with simultaneous stop-loss and take-profit orders
- Order modification and cancellation without creating duplicates
- Risk limit validation and order rejection for portfolio risk violations
- Order status tracking and event handling with fill confirmations
- Error handling and Discord notification for failed orders
- Integration with existing IBKRClient connection and market data systems

**Mock Strategy:**
```python
@pytest.fixture
def sample_order_request():
    """Provide sample OrderRequest for testing."""
    return OrderRequest(
        trade_plan_id="AAPL_20250827_001",
        symbol="AAPL",
        side=OrderSide.BUY,
        entry_price=Decimal("180.50"),
        stop_loss=Decimal("178.00"),
        take_profit=Decimal("185.00"),
        risk_category=RiskCategory.NORMAL
    )

@pytest.fixture
def mock_ibkr_order_execution():
    """Mock ib-async order placement."""
    with patch('ib_async.IB.placeOrder') as mock_order:
        mock_order.return_value = Mock(orderId=12345)
        yield mock_order
```

**AsyncIO Testing Requirements:**
```python
@pytest.mark.asyncio
async def test_market_order_placement_success(order_manager_with_mocks):
    """Test successful market order placement with position sizing."""
    order_request = sample_order_request()
    
    result = await order_manager_with_mocks.place_market_order(order_request)
    
    assert result.success is True
    assert result.order_id is not None
    assert result.order_status == OrderStatus.SUBMITTED
```

**Dependencies Required:**
- **Risk Management System:** Position sizing calculation and portfolio risk validation from Epic 1
- **IBKRClient:** Extended from Stories 2.1 and 2.2 with connection and market data capabilities
- **Discord Integration:** Notification system for order events and error alerts
- **Trade Plan System:** Integration with existing trade plan loading and management from Epic 1

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-27 | 1.0 | Initial story creation with comprehensive order execution context from architecture docs and Stories 2.1/2.2 completion insights | Scrum Master (Bob) |